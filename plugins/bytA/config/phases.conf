#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# bytA Phase Configuration (Declarative)
# ═══════════════════════════════════════════════════════════════════════════
# Format: PHASE_NUM|AGENT_NAME|PHASE_TYPE|DONE_CRITERION
#
# PHASE_TYPE:
#   APPROVAL = User muss approven (Workflow pausiert)
#   AUTO     = Auto-Advance (naechste Phase sofort)
#
# DONE_CRITERION:
#   GLOB:pattern        = Dateien muessen existieren (ls)
#   VERIFY:command       = Befehl muss exit 0 liefern
#   STATE:jq_expression  = jq-Ausdruck auf workflow-state.json
#   PHASE_STATUS         = Nur phases[N].status pruefen (completed/skipped)
# ═══════════════════════════════════════════════════════════════════════════

PHASES=(
  "0|architect-planner|APPROVAL|GLOB:.workflow/specs/issue-*-ph00-architect-planner.md"
  "1|ui-designer|APPROVAL|GLOB:wireframes/issue-*.html"
  "2|api-architect|AUTO|GLOB:.workflow/specs/issue-*-ph02-api-architect.md"
  "3|postgresql-architect|AUTO|GLOB:backend/src/main/resources/db/migration/V*.sql"
  "4|spring-boot-developer|AUTO|GLOB:.workflow/specs/issue-*-ph04-spring-boot-developer.md"
  "5|angular-frontend-developer|AUTO|GLOB:.workflow/specs/issue-*-ph05-angular-frontend-developer.md"
  "6|test-engineer|AUTO|STATE:context.testResults.allPassed==true+GLOB:.workflow/specs/issue-*-ph06-test-engineer.md"
  "7|security-auditor|APPROVAL|GLOB:.workflow/specs/issue-*-ph07-security-auditor.md"
  "8|code-reviewer|APPROVAL|GLOB:.workflow/specs/issue-*-ph08-code-reviewer.md"
  "9|ORCHESTRATOR|APPROVAL|STATE:phases[\"9\"].prUrl"
)

PHASE_NAMES=(
  "Tech Spec"
  "Wireframes"
  "API Design"
  "Migrations"
  "Backend"
  "Frontend"
  "E2E Tests"
  "Security Audit"
  "Code Review"
  "Push & PR"
)

# Phasen die WIP-Commits brauchen
WIP_COMMIT_PHASES="1 3 4 5 6"

# Maximale Retries pro Phase
MAX_RETRIES=3

# Maximale Stop-Hook-Blocks bevor Pause
MAX_STOP_HOOK_BLOCKS=15

# Phase-Daten parsen
get_phase_config() {
  local phase=$1
  echo "${PHASES[$phase]}"
}

get_phase_agent() {
  local phase=$1
  IFS='|' read -r _ agent _ _ <<< "${PHASES[$phase]}"
  echo "$agent"
}

get_phase_type() {
  local phase=$1
  IFS='|' read -r _ _ type _ <<< "${PHASES[$phase]}"
  echo "$type"
}

get_phase_criterion() {
  local phase=$1
  IFS='|' read -r _ _ _ criterion <<< "${PHASES[$phase]}"
  echo "$criterion"
}

get_phase_name() {
  local phase=$1
  echo "${PHASE_NAMES[$phase]:-Phase $phase}"
}

needs_approval() {
  [ "$(get_phase_type $1)" = "APPROVAL" ]
}

needs_commit() {
  echo "$WIP_COMMIT_PHASES" | grep -qw "$1"
}
